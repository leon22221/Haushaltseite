<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Digitales Rezeptebuch</title>
<style>
body { font-family: "Segoe UI", Tahoma, sans-serif; margin: 0; background: #f4f6f9; color: #333; }
header { background: #E53935; color: white; padding: 20px; text-align: center; font-size: 28px; }
nav { display: flex; justify-content: space-around; background: #C62828; flex-wrap: wrap; }
nav button { flex: 1 1 25%; margin: 2px; background: #C62828; border: none; color: white !important; padding: 20px 0; font-size: 20px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
nav button:hover { background: #B71C1C; }
main { padding: 15px; max-width: 1000px; margin: auto; }
.hidden { display: none; }
.card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.12); margin-bottom: 20px; color: #333; position: relative; }
.card h3 { margin-top: 0; font-size: 26px; font-weight: bold; color: #333; }
.card p { font-size: 18px; margin: 5px 0 10px 0; color: #333; }
.zutaten-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd; font-size: 18px; color: #333; }
  .zutaten-item span.preis {
  margin-right: 15px;
  font-weight: bold;
  min-width: 70px;
  text-align: right;
}
.zutaten-item span { display: inline-block; }
.zutaten-item .preis { margin-left: auto; margin-right: 15px; min-width: 60px; text-align: right; }
input, textarea { width: 100%; padding: 16px; margin: 8px 0; font-size: 18px; border-radius: 6px; border: 1px solid #ccc; color: #333; }
button.action-btn, .remove-btn { font-family: inherit; color: white !important; text-decoration: none; cursor: pointer; }
button.action-btn { width: 100%; padding: 18px 0; font-size: 20px; border-radius: 8px; margin-top: 10px; position: relative; }
.btn-red { background: #E53935; }
.btn-red:hover { background: #C62828; }
.btn-green { background: #4CAF50; }
.btn-green:hover { background-color: #45A049; }
.btn-grey { background: #9E9E9E; cursor: default; }
.remove-btn { width: 120px; min-width: 120px; padding: 10px; font-size: 16px; background: #E53935; border: none; border-radius: 6px; color: white !important; }
.remove-btn:hover { background: #C62828; }
.checkmark { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #4CAF50; opacity: 0; transition: opacity 0.5s; }
.show-check { opacity: 1; }
.terminanzeige { position: absolute; top: 12px; right: 16px; background: #E53935; color: white; padding: 6px 12px; border-radius: 20px; font-size: 16px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
@media (max-width: 768px) {
  header { font-size: 32px; padding: 25px; }
  nav { flex-direction: column; }
  nav button { font-size: 22px; padding: 22px 0; }
  .card { padding: 28px; font-size: 20px; }
  .card h3 { font-size: 30px; margin-bottom: 12px; }
  .card p { font-size: 20px; }
  .zutaten-item { font-size: 20px; padding: 10px 0; }
  input, textarea { font-size: 20px; padding: 18px; }
  button.action-btn { font-size: 22px; padding: 20px 0; }
  .remove-btn { width: 120px; min-width: 120px; }
}
#einkaufsliste strong { display: block; margin-top: 10px; font-size: 20px; text-align: right; }
</style>
</head>
<body>
<header>
  <h1>Digitales Rezeptebuch</h1>
</header>

<nav>
  <button onclick="zeigeSeite('zufall')">Zufallsrezept</button>
  <button onclick="zeigeSeite('rezepte')">Kochrezepte</button>
  <button onclick="zeigeSeite('backrezepte')">Backrezepte</button>
  <button onclick="zeigeSeite('liste')">Einkaufsliste</button>
</nav>

<main>
<section id="zufall" class="hidden">
  <div id="zufallsrezept" class="card"></div>
  <button class="btn-red action-btn" onclick="zeigeZufallsrezept()">Neues Zufallsrezept anzeigen</button>
</section>

<section id="rezepte" class="hidden">
  <input type="text" id="rezepteSuche" placeholder="Nach Rezept suchen..." oninput="sucheRezepte()">
  <div id="rezepteListe"></div>
</section>

<section id="backrezepte" class="hidden">
  <input type="text" id="backrezepteSuche" placeholder="Nach Backrezept suchen..." oninput="sucheBackrezepte()">
  <div id="backrezepteListe"></div>
</section>

<section id="liste" class="hidden">
  <div id="einkaufsliste" class="card"></div>
  <div class="card">
    <input type="text" id="manuelleZutat" placeholder="Neue Zutat eingeben">
    <button class="btn-red action-btn" onclick="addManuell()">Hinzufügen</button>
  </div>
</section>

<script src="zutatenpreise.js"></script>
<script>
let rezepte = [];
let backrezepte = [];
let einkaufsliste = JSON.parse(localStorage.getItem("einkaufsliste")) || [];
let termine = JSON.parse(localStorage.getItem("termine")) || {};

function zeigeSeite(id) {
  document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if (id === "rezepte") renderRezepte();
  if (id === "backrezepte") renderBackrezepte();
  if (id === "liste") renderListe();
}

async function ladeRezepte() {
  try {
    const res1 = await fetch("rezepte.json");
    rezepte = await res1.json();
    const res2 = await fetch("backrezepte.json");
    backrezepte = await res2.json();
    renderRezepte();
    renderBackrezepte();
    zeigeZufallsrezept();
  } catch (err) {
    console.error("Fehler beim Laden der Rezepte:", err);
  }
}

function parseZutat(zutat) {
  zutat = zutat.trim();
  // Form: 1x Name
  let matchX = zutat.match(/^([0-9]+)x\s+(.+)$/i);
  if (matchX) return { menge: parseInt(matchX[1]), einheit: "x", name: matchX[2].trim() };

  // Form: Menge + Einheit + Name (z.B. 500g Nudeln)
  const match = zutat.match(/^([0-9,.]+)?\s*(g|kg|ml|l)?\s*(.+)$/i);
  let menge = 1, einheit = "x", name = zutat;
  if (match) {
    menge = match[1] ? parseFloat(match[1].replace(",", ".")) : 1;
    einheit = match[2] || "x";
    name = match[3].trim() || zutat;

    if (einheit.toLowerCase() === "kg") { menge *= 1000; einheit = "g"; }
    if (einheit.toLowerCase() === "l") { menge *= 1000; einheit = "ml"; }
  }
  return { name, menge, einheit };
}
  
function addToList(index, typ="rezepte", button=null) {
  const quelle = typ==="rezepte"?rezepte:backrezepte;
  quelle[index].zutaten.forEach(z=>einkaufsliste.push(z));
  speicherListe();
  renderListe();
  if(button){
    const check = document.createElement('span');
    check.className='checkmark show-check';
    check.innerHTML='✔';
    button.appendChild(check);
  }
}

function addManuell() {
  const input = document.getElementById("manuelleZutat");
  let wert = input.value.trim();
  if(wert!=="") {
    let ohneX = wert.match(/^([0-9]+)\s+(.+)$/);
    if(ohneX) wert=`${ohneX[1]}x ${ohneX[2]}`;
    einkaufsliste.push(wert);
    input.value="";
    speicherListe();
    renderListe();
  }
}

function removeFromListByName(name, einheit) {
  einkaufsliste = einkaufsliste.filter(z => {
    const parsed = parseZutat(z);
    return !(parsed.name.toLowerCase() === name.toLowerCase() && parsed.einheit === einheit);
  });
  speicherListe();
  renderListe();
}

function getPreis(name, menge, einheit) {
  if (!window.zutatPreise) return null;

  const lowerName = name.toLowerCase();
  let eintrag = null;

  // Direktes Matching
  for (const key in zutatPreise) {
    if (key.toLowerCase() === lowerName) {
      eintrag = zutatPreise[key];
      break;
    }
  }

  if (!eintrag) return null;

  // Faktor berechnen
  const e = einheit.toLowerCase();
  const be = eintrag.einheit.toLowerCase();
  let faktor;

  if (be === e) faktor = menge / eintrag.menge;
  else if (be === "g" && e === "kg") faktor = (menge*1000)/eintrag.menge;
  else if (be === "kg" && e === "g") faktor = (menge/1000)/eintrag.menge;
  else if (be === "ml" && e === "l") faktor = (menge*1000)/eintrag.menge;
  else if (be === "l" && e === "ml") faktor = (menge/1000)/eintrag.menge;
  else if (be === "x" && e === "x") faktor = menge / eintrag.menge;
  else return null;

  return eintrag.preis * faktor;
}




function renderListe() {
  const div = document.getElementById("einkaufsliste");
  div.innerHTML = "<h3>Einkaufsliste</h3>";

  let zusammenfassung = {};
  einkaufsliste.forEach(z => {
    const {name, menge, einheit} = parseZutat(z);
    const key = name.toLowerCase() + "|" + einheit;
    if(zusammenfassung[key]) zusammenfassung[key] += menge;
    else zusammenfassung[key] = menge;
  });

  let gesamtkosten = 0;

  Object.entries(zusammenfassung).forEach(([key, menge]) => {
    let [name, einheit] = key.split('|');
    let anzeige = einheit === 'x' ? `${menge}x ${name}` : `${menge}${einheit} ${name}`;

    let kosten = getPreis(name, menge, einheit);
    let preisText = kosten != null ? `${kosten.toFixed(2)} €` : "0,00 €";

    if (kosten != null) gesamtkosten += kosten;

    const item = document.createElement("div");
    item.className = "zutaten-item";
    item.innerHTML = `
      <span>${anzeige}</span>
      <span class="preis">${preisText}</span>
      <button class='remove-btn' onclick="removeFromListByName('${name}','${einheit}')">Entfernen</button>
    `;
    div.appendChild(item);
  });

  const summeDiv = document.createElement("div");
  summeDiv.className = "zutaten-item";
  summeDiv.innerHTML = `<strong>Gesamtkosten: ${gesamtkosten.toFixed(2)} €</strong>`;
  div.appendChild(summeDiv);
}


// Zufallsrezept
function zeigeZufallsrezept() {
  const alleRezepte = rezepte.concat(backrezepte);
  if(!alleRezepte.length) return;
  const zufall=Math.floor(Math.random()*alleRezepte.length);
  const r=alleRezepte[zufall];
  const container=document.getElementById("zufallsrezept");
  container.innerHTML=`
    <h3>${r.name}</h3>
    ${r.kategorie?`<p><strong>Kategorie:</strong> ${r.kategorie}</p>`:''}
    ${r.zeit?`<p><strong>Zubereitungszeit:</strong> ${r.zeit}</p>`:''}
    <h4>Zutaten:</h4><ul>${r.zutaten.map(z=>`<li>${z}</li>`).join('')}</ul>
    <button class='btn-red action-btn' onclick='addToList(${rezepte.indexOf(r)}, "rezepte", this)'>Zur Einkaufsliste hinzufügen</button>
    <button class='${r.link?'btn-green':'btn-grey'} action-btn' ${r.link?`onclick="window.open('${r.link}','_blank')"`:'disabled'}>Rezept ansehen</button>
  `;
}

// --- Termin-Funktionen ---
function setTermin(rezeptName) {
  const datum = prompt("Bitte Datum auswählen (Format: YYYY-MM-DD):");
  if(!datum) return;
  const terminDatum = new Date(datum);
  if(isNaN(terminDatum.getTime())) { alert("Ungültiges Datum!"); return; }
  termine[rezeptName]=datum;
  localStorage.setItem("termine", JSON.stringify(termine));
  renderRezepte();
}

function getDayAbbreviation(datumStr) {
  const days=["So","Mo","Di","Mi","Do","Fr","Sa"];
  const d=new Date(datumStr);
  return days[d.getDay()];
}

function isTerminAktiv(datumStr) {
  const heute=new Date();
  const termin=new Date(datumStr);
  const diff=heute-termin;
  return diff<24*60*60*1000;
}

// --- Rezepte rendern ---
function renderRezepte(filter="") {
  const liste=document.getElementById("rezepteListe");
  liste.innerHTML="";
  rezepte.filter(r=>r.name.toLowerCase().includes(filter.toLowerCase())).forEach((r,idx)=>{
    const div=document.createElement("div");
    div.className="card";
    let terminHTML="";
    if(termine[r.name] && isTerminAktiv(termine[r.name])) {
      const d=new Date(termine[r.name]);
      terminHTML=`<div class="terminanzeige">${getDayAbbreviation(termine[r.name])}, ${d.getDate()}</div>`;
    } else if(termine[r.name]) { delete termine[r.name]; localStorage.setItem("termine", JSON.stringify(termine)); }
    div.innerHTML=`
      ${terminHTML}
      <h3>${r.name}</h3>
      ${r.kategorie?`<p><strong>Kategorie:</strong> ${r.kategorie}</p>`:''}
      <ul>${r.zutaten.map(z=>`<li>${z}</li>`).join("")}</ul>
      <button onclick="addToList(${idx}, 'rezepte', this)" class="btn-red action-btn">Zur Einkaufsliste hinzufügen</button>
      <button class="btn-green action-btn" onclick="setTermin('${r.name}')">Terminieren für</button>
      <button class="${r.link?'btn-green':'btn-grey'} action-btn" ${r.link?`onclick="window.open('${r.link}','_blank')"`:'disabled'}>Rezept ansehen</button>
    `;
    liste.appendChild(div);
  });
}

function sucheRezepte() {
  const wert=document.getElementById("rezepteSuche").value;
  renderRezepte(wert);
}

function renderBackrezepte(filter="") {
  const liste=document.getElementById("backrezepteListe");
  liste.innerHTML="";
  backrezepte.filter(r=>r.name.toLowerCase().includes(filter.toLowerCase())).forEach((r,idx)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h3>${r.name}</h3>
      <p><strong>Zubereitungszeit:</strong> ${r.zeit}</p>
      <ul>${r.zutaten.map(z=>`<li>${z}</li>`).join("")}</ul>
      <button onclick="addToList(${idx}, 'backrezepte', this)" class="btn-red action-btn">Zur Einkaufsliste hinzufügen</button>
      <button class="${r.link?'btn-green':'btn-grey'} action-btn" ${r.link?`onclick="window.open('${r.link}','_blank')"`:'disabled'}>Rezept ansehen</button>
    `;
    liste.appendChild(div);
  });
}

function sucheBackrezepte() {
  const wert=document.getElementById("backrezepteSuche").value;
  renderBackrezepte(wert);
}

function speicherListe() {
  localStorage.setItem("einkaufsliste", JSON.stringify(einkaufsliste));
}

// Init
zeigeSeite("zufall");
ladeRezepte();
</script>
</body>
</html>
